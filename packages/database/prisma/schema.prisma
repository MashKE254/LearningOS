// EduForge Database Schema
// Generative Teaching Infrastructure - Complete Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

enum UserRole {
  STUDENT
  PARENT
  TEACHER
  ADMIN
  INSTITUTION_ADMIN
}

enum SubscriptionTier {
  FREE
  STUDENT_PRO      // $14/month
  FAMILY_PRO       // $29/month
  TEACHER_PRO      // $19/month
  INSTITUTION      // $8/student/year
  ENTERPRISE
}

enum UserPersona {
  CRISIS           // "My exam is coming up fast"
  PARENT           // "I want to support my child's learning"
  CAREER           // "I'm learning new skills for work"
  TEACHER          // "I want tools for my classroom"
  STUDENT          // "I just want to get better at a subject"
}

model User {
  id                  String            @id @default(cuid())
  email               String            @unique
  passwordHash        String?
  name                String
  role                UserRole          @default(STUDENT)
  avatarUrl           String?
  preferredLanguage   String            @default("en")
  timezone            String            @default("UTC")

  // Persona-based onboarding
  primaryPersona      UserPersona?
  secondaryPersonas   UserPersona[]
  onboardingCompleted Boolean           @default(false)

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  studentProfile      StudentProfile?
  parentProfile       ParentProfile?
  teacherProfile      TeacherProfile?
  subscription        Subscription?
  sessions            Session[]
  oauthAccounts       OAuthAccount[]
  accessibilitySettings AccessibilitySettings?
  materialUploads     MaterialUpload[]
}

model OAuthAccount {
  id                String   @id @default(cuid())
  userId            String
  provider          String   // google, microsoft, clever
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         DateTime?

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  userAgent String?
  ipAddress String?

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Subscription {
  id                   String           @id @default(cuid())
  userId               String           @unique
  tier                 SubscriptionTier @default(FREE)
  status               String           @default("active") // active, canceled, past_due
  stripeCustomerId     String?
  stripeSubscriptionId String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  user                 User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// ACCESSIBILITY SETTINGS
// ============================================

model AccessibilitySettings {
  id              String   @id @default(cuid())
  userId          String   @unique

  // Mode toggles
  adhdFriendly    Boolean  @default(false)
  dyslexiaFriendly Boolean @default(false)
  visionImpaired  Boolean  @default(false)
  autismFriendly  Boolean  @default(false)
  anxietySensitive Boolean @default(false)
  seizureSafe     Boolean  @default(false)

  // Visual settings
  fontSize        String   @default("medium") // small, medium, large, xlarge
  fontFamily      String   @default("default") // default, opendyslexic, sans-serif
  highContrast    Boolean  @default(false)
  reducedMotion   Boolean  @default(false)

  // Audio settings
  textToSpeech    Boolean  @default(false)
  voiceInput      Boolean  @default(false)

  // Session settings
  maxSessionMinutes Int    @default(60)
  breakReminders  Boolean  @default(false)
  breakIntervalMinutes Int @default(25)

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// STUDENT PROFILE & KNOWLEDGE GRAPH
// ============================================

enum LearningStyle {
  VISUAL
  AUDITORY
  KINESTHETIC
  READING_WRITING
  MIXED
}

enum LearningModeType {
  LEARN          // Socratic dialogue, concept explanation
  PRACTICE       // Problem-solving, minimal AI intervention
  EXAM           // Timed, no help, examiner mode
  DEBUG          // Misconception repair mode
  REVIEW         // Post-exam Socratic review
}

model StudentProfile {
  id                  String              @id @default(cuid())
  userId              String              @unique
  dateOfBirth         DateTime?
  gradeLevel          Int?
  learningStyle       LearningStyle       @default(MIXED)
  nativeLanguage      String              @default("en")
  targetLanguage      String?             // For bilingual learning
  specialNeeds        String[]            // ADHD, dyslexia, vision issues, etc.
  interests           String[]            // For contextual learning
  dailyGoalMinutes    Int                 @default(30)

  // Crisis mode
  inCrisisMode        Boolean             @default(false)
  crisisExamDate      DateTime?
  crisisExamSubject   String?

  // Current learning state
  currentMode         LearningModeType    @default(LEARN)
  currentSessionId    String?

  // Relations
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments         CurriculumEnrollment[]
  knowledgeNodes      KnowledgeNode[]
  learningSessions    LearningSession[]
  assessments         Assessment[]
  parentLinks         ParentStudentLink[]
  classEnrollments    ClassEnrollment[]
  studyPlans          StudyPlan[]
  learningNeeds       LearningNeed[]
  learningNeedVotes   LearningNeedVote[]
  confidenceReports   ConfidenceReport[]
  behaviorEvents      BehaviorEvent[]

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
}

// The living knowledge graph per student
model KnowledgeNode {
  id                  String          @id @default(cuid())
  studentId           String
  conceptId           String

  // Mastery tracking (0.0 to 1.0)
  masteryLevel        Float           @default(0.0)
  confidence          Float           @default(0.0)

  // Spaced repetition (Bayesian IRT + forgetting curves)
  lastPracticed       DateTime?
  nextReviewDate      DateTime?
  reviewCount         Int             @default(0)
  halfLifeDays        Float?          // Estimated memory half-life

  // Misconception tracking
  misconceptions      Json[]          // Array of identified misconceptions
  misconceptionCount  Int             @default(0)

  // Prerequisites mastered
  prerequisitesMet    Boolean         @default(false)

  // Exam relevance
  examRelevance       Json?           // {paper: "Paper 2", marks: 6, frequency: 0.8}
  pastPaperAppearances Int            @default(0)

  student             StudentProfile  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  concept             Concept         @relation(fields: [conceptId], references: [id])

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@unique([studentId, conceptId])
  @@index([studentId, masteryLevel])
  @@index([studentId, nextReviewDate])
}

// ============================================
// MODE SYSTEM
// ============================================

model ModeTransition {
  id              String           @id @default(cuid())
  sessionId       String
  fromMode        LearningModeType
  toMode          LearningModeType
  trigger         String           // auto_mastery, auto_error, student_request, teacher_forced
  triggerData     Json?            // Additional context about the trigger

  session         LearningSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt       DateTime         @default(now())

  @@index([sessionId, createdAt])
}

// ============================================
// CONFIDENCE TRACKING
// ============================================

model ConfidenceReport {
  id                  String         @id @default(cuid())
  studentId           String
  sessionId           String
  interactionId       String?
  questionId          String?

  // Student self-report (0.2 = guessed, 0.5 = somewhat sure, 0.9 = confident)
  studentConfidence   Float

  // AI estimated confidence
  aiConfidence        Float?
  aiConfidenceFactors Json?          // Factors that influenced AI estimate

  // Divergence detection
  hasDivergence       Boolean        @default(false)
  divergenceHandled   Boolean        @default(false)

  student             StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  session             LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt           DateTime       @default(now())

  @@index([studentId, createdAt])
  @@index([sessionId])
}

// ============================================
// BEHAVIOR TRACKING & PROACTIVE INTERVENTION
// ============================================

enum BehaviorEventType {
  HESITATION           // Long pause before responding
  RAPID_ANSWER         // Very quick answer (possible guessing)
  SESSION_GAP          // Long gap between sessions
  ENGAGEMENT_DROP      // Shorter responses, less interaction
  ERROR_PATTERN        // Repeated similar errors
  FRUSTRATION_SIGNAL   // Detected frustration in language
  CONFIDENCE_DIVERGENCE // Student confidence doesn't match performance
  MASTERY_PLATEAU      // No progress despite practice
}

model BehaviorEvent {
  id              String            @id @default(cuid())
  studentId       String
  sessionId       String?
  eventType       BehaviorEventType
  eventData       Json              // Specific data for this event type

  // For hesitation: {pauseSeconds: 45, expectedSeconds: 10}
  // For error_pattern: {misconceptionId: "...", occurrenceCount: 3}

  processed       Boolean           @default(false)
  nudgeTriggered  Boolean           @default(false)

  student         StudentProfile    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  session         LearningSession?  @relation(fields: [sessionId], references: [id])
  nudge           Nudge?

  createdAt       DateTime          @default(now())

  @@index([studentId, eventType])
  @@index([sessionId])
}

enum NudgeType {
  HESITATION_HELP      // "You're pausing longer than usual..."
  SIMPLIFY_OFFER       // "Want to try a simpler case?"
  REASONING_CHECK      // "This is right, but won't earn full marks. Why?"
  ADVANCEMENT_OFFER    // "You've mastered this. Want to move faster?"
  CONFIDENCE_PROBE     // "You said confident, but let me check..."
  RETURN_PROMPT        // "You haven't practiced [topic] in 5 days..."
  BREAK_SUGGESTION     // "You've been working for 45 minutes..."
  MISCONCEPTION_ALERT  // "Pause. You're applying the wrong rule here."
}

model Nudge {
  id              String           @id @default(cuid())
  studentId       String
  sessionId       String?
  behaviorEventId String?          @unique
  nudgeType       NudgeType
  message         String

  // Delivery tracking
  delivered       Boolean          @default(false)
  deliveredAt     DateTime?

  // Response tracking
  responded       Boolean          @default(false)
  responseType    String?          // accepted, dismissed, ignored
  responseAt      DateTime?

  behaviorEvent   BehaviorEvent?   @relation(fields: [behaviorEventId], references: [id])
  session         LearningSession? @relation(fields: [sessionId], references: [id])

  createdAt       DateTime         @default(now())

  @@index([studentId, createdAt])
}

// ============================================
// THINKING TRACES
// ============================================

model ThinkingTrace {
  id              String      @id @default(cuid())
  interactionId   String

  // Structured reasoning steps
  steps           Json        // [{step: "Checking knowledge graph", detail: "..."}]

  // Display settings
  showToStudent   Boolean     @default(true)
  expandedByDefault Boolean   @default(false)

  interaction     Interaction @relation(fields: [interactionId], references: [id], onDelete: Cascade)

  createdAt       DateTime    @default(now())
}

// ============================================
// CURRICULUM STRUCTURE (RAG Source)
// ============================================

model ExamBoard {
  id          String       @id @default(cuid())
  name        String       // IGCSE, KCSE, CBSE, Common Core, IB, A-Level, AP
  code        String       @unique // CIE, KNEC, CBSE, CC, IB, etc.
  country     String
  description String?
  logoUrl     String?

  curricula   Curriculum[]
}

model Curriculum {
  id              String                  @id @default(cuid())
  examBoardId     String
  name            String                  // "CIE Biology 9700"
  code            String                  // "9700"
  subject         String
  subjectArea     String?                 // "Sciences", "Mathematics", "Languages"
  yearGroup       String?                 // "Year 10", "Grade 11"
  version         String                  @default("2024")
  isActive        Boolean                 @default(true)

  examBoard       ExamBoard               @relation(fields: [examBoardId], references: [id])
  units           CurriculumUnit[]
  enrollments     CurriculumEnrollment[]
  examPapers      ExamPaper[]
  ingestions      CurriculumIngestion[]

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  @@unique([examBoardId, code, version])
}

model CurriculumUnit {
  id              String           @id @default(cuid())
  curriculumId    String
  name            String
  code            String?          // Unit code from syllabus
  description     String?
  sequenceOrder   Int
  estimatedHours  Float?

  curriculum      Curriculum       @relation(fields: [curriculumId], references: [id], onDelete: Cascade)
  topics          Topic[]

  @@index([curriculumId, sequenceOrder])
}

model Topic {
  id              String           @id @default(cuid())
  unitId          String
  name            String
  code            String?          // Topic code from syllabus
  description     String?
  sequenceOrder   Int
  estimatedHours  Float?

  // Exam relevance
  examWeight      Float?           // Percentage of exam marks
  typicalMarks    Int?             // Typical marks per question

  unit            CurriculumUnit   @relation(fields: [unitId], references: [id], onDelete: Cascade)
  concepts        Concept[]
  learningObjectives LearningObjective[]

  @@index([unitId, sequenceOrder])
}

model Concept {
  id              String          @id @default(cuid())
  topicId         String
  name            String
  description     String
  difficulty      Int             @default(1) // 1-5

  // For RAG - vectorized content
  contentChunks   ContentChunk[]

  // Prerequisites
  prerequisites   Concept[]       @relation("ConceptPrerequisites")
  dependents      Concept[]       @relation("ConceptPrerequisites")

  // Exam data
  examCommandWords String[]       // "describe", "explain", "evaluate"
  commonMistakes  String[]
  keyTerms        String[]        // Terms required for full marks

  topic           Topic           @relation(fields: [topicId], references: [id], onDelete: Cascade)
  knowledgeNodes  KnowledgeNode[]
  questions       Question[]

  @@index([topicId])
}

model LearningObjective {
  id              String   @id @default(cuid())
  topicId         String
  code            String   // Official syllabus code e.g., "1.2.3"
  description     String
  assessmentCriteria String?
  bloomsLevel     Int      @default(1) // 1-6 (Remember to Create)

  topic           Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([topicId, code])
}

// Vectorized content for RAG
model ContentChunk {
  id              String   @id @default(cuid())
  conceptId       String
  content         String   // The actual text
  contentType     String   // explanation, example, analogy, common_mistake, mark_scheme
  embedding       Float[]  // Vector embedding for similarity search
  source          String?  // Textbook, syllabus document, etc.
  sourceUrl       String?
  metadata        Json?    // Additional metadata

  concept         Concept  @relation(fields: [conceptId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@index([conceptId])
}

// ============================================
// CURRICULUM INGESTION PIPELINE
// ============================================

enum IngestionStatus {
  PENDING
  PROCESSING
  REVIEW_NEEDED
  APPROVED
  REJECTED
  FAILED
}

model CurriculumIngestion {
  id              String          @id @default(cuid())
  curriculumId    String?

  // Source document
  sourceType      String          // pdf, api, html
  sourceUrl       String?
  fileName        String?
  fileSize        Int?

  // Processing status
  status          IngestionStatus @default(PENDING)
  errorMessage    String?

  // Extracted data (before approval)
  extractedData   Json?           // The structured curriculum data
  extractionModel String?         // Which AI model was used

  // Review
  reviewedBy      String?         // Admin user ID
  reviewNotes     String?

  curriculum      Curriculum?     @relation(fields: [curriculumId], references: [id])

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([status])
}

model MaterialUpload {
  id              String   @id @default(cuid())
  userId          String
  fileName        String
  fileType        String   // pdf, pptx, docx, video, etc.
  fileSize        Int
  fileUrl         String   // S3 or storage URL

  // Processing
  processed       Boolean  @default(false)
  processedAt     DateTime?
  chunkCount      Int?

  // Metadata
  title           String?
  description     String?
  curriculumId    String?
  topicIds        String[]

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@index([userId])
}

// ============================================
// EXAM PAPERS & MARKING SCHEMES
// ============================================

model ExamPaper {
  id              String     @id @default(cuid())
  curriculumId    String
  year            Int
  session         String     // May, November, etc.
  paperNumber     String     // Paper 1, Paper 2
  paperType       String?    // Multiple choice, Structured, Essay
  title           String
  totalMarks      Int
  duration        Int        // minutes

  curriculum      Curriculum @relation(fields: [curriculumId], references: [id])
  questions       Question[]
  examSimulations ExamSimulation[]

  @@unique([curriculumId, year, session, paperNumber])
}

model Question {
  id                String         @id @default(cuid())
  examPaperId       String?
  conceptId         String
  questionNumber    String?        // "1a", "2b(ii)"
  questionText      String
  questionType      String         // multiple_choice, short_answer, essay, calculation, mechanism
  difficulty        Int            @default(1) // 1-5
  marks             Int            @default(1)
  markingScheme     Json           // Detailed marking criteria
  modelAnswer       String?
  commonMistakes    String[]
  commandWord       String?        // describe, explain, evaluate, etc.

  // For generated questions
  isGenerated       Boolean        @default(false)
  generationParams  Json?

  // Statistics
  averageScore      Float?
  attemptCount      Int            @default(0)

  examPaper         ExamPaper?     @relation(fields: [examPaperId], references: [id])
  concept           Concept        @relation(fields: [conceptId], references: [id])
  responses         QuestionResponse[]
  examAnswers       ExamAnswer[]

  createdAt         DateTime       @default(now())

  @@index([conceptId, difficulty])
}

// ============================================
// EXAM SIMULATION
// ============================================

model ExamSimulation {
  id              String       @id @default(cuid())
  studentId       String
  sessionId       String?
  examPaperId     String?

  // Exam settings
  title           String
  totalMarks      Int
  durationMinutes Int

  // Timing
  startedAt       DateTime     @default(now())
  endedAt         DateTime?
  timeSpentSeconds Int?

  // Grading
  totalScore      Float?
  percentage      Float?
  graded          Boolean      @default(false)
  gradedAt        DateTime?

  // Review
  reviewCompleted Boolean      @default(false)
  reviewSessionId String?      // The review learning session

  examPaper       ExamPaper?   @relation(fields: [examPaperId], references: [id])
  answers         ExamAnswer[]

  createdAt       DateTime     @default(now())

  @@index([studentId, createdAt])
}

model ExamAnswer {
  id              String         @id @default(cuid())
  simulationId    String
  questionId      String
  questionNumber  Int            // Order in the exam

  // Answer
  answerText      String?
  answerData      Json?          // For structured answers (math, code, diagrams)

  // Timing
  startedAt       DateTime?
  submittedAt     DateTime?
  timeSpentSeconds Int?

  // Grading
  score           Float?
  maxScore        Float
  feedback        String?
  markSchemeNotes Json?          // Which criteria were met/missed

  // Flags
  flaggedForReview Boolean       @default(false)
  skipped         Boolean        @default(false)

  simulation      ExamSimulation @relation(fields: [simulationId], references: [id], onDelete: Cascade)
  question        Question       @relation(fields: [questionId], references: [id])

  @@index([simulationId])
}

// ============================================
// CRISIS TRIAGE / STUDY PLANS
// ============================================

model StudyPlan {
  id              String         @id @default(cuid())
  studentId       String

  // Context
  examDate        DateTime
  examSubject     String
  curriculumId    String?

  // Diagnostic results
  diagnosticScore Float?
  identifiedGaps  Json           // [{conceptId, masteryLevel, priority}]

  // Plan
  title           String
  totalDays       Int
  hoursPerDay     Float

  // Status
  status          String         @default("active") // active, completed, abandoned
  completedAt     DateTime?

  student         StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  days            StudyPlanDay[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([studentId])
}

model StudyPlanDay {
  id              String    @id @default(cuid())
  planId          String
  dayNumber       Int
  date            DateTime

  // Tasks
  tasks           Json      // [{type, conceptId, description, estimatedMinutes, completed}]

  // Progress
  completed       Boolean   @default(false)
  completedAt     DateTime?
  actualMinutes   Int?

  plan            StudyPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId, dayNumber])
}

// ============================================
// LEARNING SESSIONS & INTERACTIONS
// ============================================

enum SessionMode {
  SCHOOL_STUFF       // Curriculum-based homework help
  LEARN_SOMETHING_NEW // Skill acquisition
  EXAM_PREP          // Crisis mode exam preparation
  CAREER_CHANGE      // Professional reskilling
}

model LearningSession {
  id                String           @id @default(cuid())
  studentId         String
  mode              SessionMode      @default(SCHOOL_STUFF)
  learningMode      LearningModeType @default(LEARN)
  startedAt         DateTime         @default(now())
  endedAt           DateTime?
  durationMinutes   Int?

  // Context
  curriculumId      String?
  topicId           String?
  conceptId         String?

  // Mode history
  modeTransitions   ModeTransition[]

  // AI Model usage tracking
  modelUsage        Json             // {haiku: 10, sonnet: 5, opus: 1}
  totalTokens       Int              @default(0)
  estimatedCostUsd  Float            @default(0)

  // Proactive intervention tracking
  nudgeCount        Int              @default(0)

  student           StudentProfile   @relation(fields: [studentId], references: [id])
  interactions      Interaction[]
  assessments       Assessment[]
  confidenceReports ConfidenceReport[]
  behaviorEvents    BehaviorEvent[]
  nudges            Nudge[]

  @@index([studentId, startedAt])
}

model Interaction {
  id              String          @id @default(cuid())
  sessionId       String
  role            String          // user, assistant, system
  content         String
  contentType     String          @default("text") // text, code, latex, image, voice

  // Mode context
  learningMode    LearningModeType?

  // AI routing info
  modelUsed       String?         // haiku, sonnet, opus, wolfram, rdkit
  tokensUsed      Int?
  latencyMs       Int?

  // Retrieved context (for RAG transparency)
  retrievedChunks String[]        // IDs of content chunks used
  citations       Json?           // Formatted citations

  // Verification results
  verified        Boolean         @default(false)
  verificationMethod String?      // wolfram, rdkit, judge0
  verificationResult Json?

  // Thinking trace
  thinkingTrace   ThinkingTrace?

  // Proactive intervention
  wasProactive    Boolean         @default(false)
  nudgeId         String?

  // Confidence data (for practice mode)
  studentConfidence Float?
  aiConfidence    Float?

  session         LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt       DateTime        @default(now())

  @@index([sessionId, createdAt])
}

// ============================================
// ASSESSMENTS & PROGRESS
// ============================================

model Assessment {
  id              String           @id @default(cuid())
  studentId       String
  sessionId       String?
  assessmentType  String           // diagnostic, formative, summative, mock_exam
  title           String?

  // Results
  score           Float?
  maxScore        Float?
  completedAt     DateTime?
  timeSpentMinutes Int?

  student         StudentProfile   @relation(fields: [studentId], references: [id])
  session         LearningSession? @relation(fields: [sessionId], references: [id])
  responses       QuestionResponse[]

  createdAt       DateTime         @default(now())

  @@index([studentId, createdAt])
}

model QuestionResponse {
  id              String     @id @default(cuid())
  assessmentId    String
  questionId      String
  studentAnswer   String

  // AI Grading
  score           Float?
  maxScore        Float
  feedback        String?
  feedbackType    String?    // correct, partial, incorrect, misconception
  misconceptionId String?    // Link to identified misconception pattern

  // Confidence
  studentConfidence Float?

  // Timestamps
  startedAt       DateTime   @default(now())
  submittedAt     DateTime?

  assessment      Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  question        Question   @relation(fields: [questionId], references: [id])

  @@index([assessmentId])
}

// ============================================
// LEARNING NEEDS BOARD
// ============================================

model LearningNeed {
  id              String             @id @default(cuid())
  studentId       String
  classId         String?

  // The need
  title           String             // "I don't understand ionic bonding"
  description     String?
  conceptId       String?
  topicId         String?

  // Status
  status          String             @default("open") // open, addressed, resolved
  addressedAt     DateTime?
  addressedBy     String?            // Teacher ID

  // AI suggestions
  aiSuggestedTopics String[]
  aiGroupedWith   String[]           // IDs of related needs

  student         StudentProfile     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  votes           LearningNeedVote[]

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([classId, status])
}

model LearningNeedVote {
  id              String        @id @default(cuid())
  needId          String
  studentId       String

  need            LearningNeed  @relation(fields: [needId], references: [id], onDelete: Cascade)
  student         StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt       DateTime      @default(now())

  @@unique([needId, studentId])
}

// ============================================
// PARENT & TEACHER FEATURES
// ============================================

model ParentProfile {
  id              String              @id @default(cuid())
  userId          String              @unique

  // Notification preferences
  notifyOnStruggle Boolean            @default(true)
  notifyOnMilestone Boolean           @default(true)
  digestFrequency String              @default("daily") // realtime, daily, weekly

  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  studentLinks    ParentStudentLink[]
  notifications   ParentNotification[]
}

model ParentStudentLink {
  id              String         @id @default(cuid())
  parentId        String
  studentId       String
  relationship    String         @default("parent") // parent, guardian, tutor
  canViewProgress Boolean        @default(true)
  canSetGoals     Boolean        @default(true)
  canViewTranscripts Boolean     @default(false)

  parent          ParentProfile  @relation(fields: [parentId], references: [id], onDelete: Cascade)
  student         StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt       DateTime       @default(now())

  @@unique([parentId, studentId])
}

model ParentNotification {
  id              String        @id @default(cuid())
  parentId        String
  type            String        // struggle_alert, milestone, daily_summary, misconception_alert
  title           String
  message         String
  studentId       String?
  studentName     String?

  // Rich data
  data            Json?         // Additional structured data
  actionUrl       String?       // Link to relevant page

  read            Boolean       @default(false)
  readAt          DateTime?

  parent          ParentProfile @relation(fields: [parentId], references: [id], onDelete: Cascade)

  createdAt       DateTime      @default(now())

  @@index([parentId, read, createdAt])
}

model TeacherProfile {
  id              String        @id @default(cuid())
  userId          String        @unique
  institutionId   String?
  department      String?
  subjects        String[]
  gradeLevels     String[]

  // Preferences
  morningBriefTime String?      // "06:30"

  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution     Institution?  @relation(fields: [institutionId], references: [id])
  classes         Class[]
  studentRooms    StudentRoom[]
}

// ============================================
// STUDENT ROOMS (Teacher-Controlled AI Spaces)
// ============================================

model StudentRoom {
  id              String                  @id @default(cuid())
  teacherId       String
  classId         String?

  name            String
  description     String?

  // Status
  isActive        Boolean                 @default(true)
  isPaused        Boolean                 @default(false)

  // Configuration
  allowedModes    LearningModeType[]
  allowedTools    String[]                // math_editor, code_editor, diagram, etc.
  topicRestrictions String[]              // Limit to specific topic IDs
  difficultyMin   Int                     @default(1)
  difficultyMax   Int                     @default(5)

  // Time limits
  maxSessionMinutes Int?

  // Transcript visibility
  transcriptsVisible Boolean              @default(true)

  teacher         TeacherProfile          @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  @@index([teacherId])
  @@index([classId])
}

// ============================================
// INSTITUTIONAL TIER
// ============================================

model Institution {
  id              String           @id @default(cuid())
  name            String
  type            String           // school, district, university
  country         String
  state           String?

  // Settings
  ssoProvider     String?          // clever, google, microsoft
  ssoDomain       String?
  ssoConfig       Json?

  // Branding
  logoUrl         String?
  primaryColor    String?

  teachers        TeacherProfile[]
  classes         Class[]

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model Class {
  id              String            @id @default(cuid())
  teacherId       String
  institutionId   String?
  name            String            // "7th Grade Math Period 3"
  subject         String
  gradeLevel      String?
  curriculumId    String?
  academicYear    String

  // Pacing
  pacingGuide     Json?             // Week-by-week topic schedule

  // Settings
  aiEnabled       Boolean           @default(true)

  teacher         TeacherProfile    @relation(fields: [teacherId], references: [id])
  institution     Institution?      @relation(fields: [institutionId], references: [id])
  enrollments     ClassEnrollment[]
  assignments     Assignment[]
  learningNeeds   LearningNeed[]

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([teacherId])
}

model ClassEnrollment {
  id              String         @id @default(cuid())
  classId         String
  studentId       String
  status          String         @default("active") // active, inactive, withdrawn
  enrolledAt      DateTime       @default(now())

  class           Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  student         StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
}

model Assignment {
  id              String           @id @default(cuid())
  classId         String
  title           String
  description     String?
  instructions    String?
  dueDate         DateTime?

  // AI-generated or teacher-created
  isAiGenerated   Boolean          @default(false)
  topicIds        String[]
  conceptIds      String[]
  questionCount   Int?
  difficultyRange Int[]            @default([1, 3])

  // AI-resistant settings
  isAiResistant   Boolean          @default(false)
  aiResistantFeatures String[]     // personalized_data, multi_step, reflection_required

  // Variants (for anti-cheating)
  hasVariants     Boolean          @default(false)
  variantSeed     String?

  class           Class            @relation(fields: [classId], references: [id], onDelete: Cascade)

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([classId, dueDate])
}

// ============================================
// CURRICULUM ENROLLMENT
// ============================================

model CurriculumEnrollment {
  id              String         @id @default(cuid())
  studentId       String
  curriculumId    String
  enrolledAt      DateTime       @default(now())
  targetExamDate  DateTime?

  // Progress
  overallProgress Float          @default(0)
  lastActivityAt  DateTime?

  student         StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  curriculum      Curriculum     @relation(fields: [curriculumId], references: [id])

  @@unique([studentId, curriculumId])
}

// ============================================
// CAREER CHANGE TRACK
// ============================================

model CareerTrack {
  id              String   @id @default(cuid())
  name            String   // "Data Analytics", "Web Development"
  slug            String   @unique
  description     String
  targetRole      String   // "Data Analyst", "Frontend Developer"
  estimatedWeeks  Int
  difficulty      Int      @default(2) // 1-3

  // Content
  overview        String?
  prerequisites   String[]
  outcomes        String[]

  skills          Skill[]
  projects        ProjectTemplate[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Skill {
  id              String      @id @default(cuid())
  trackId         String
  name            String
  description     String
  sequenceOrder   Int
  estimatedHours  Float?

  // Content
  learningObjectives String[]
  resources       Json?       // [{type, title, url}]

  track           CareerTrack @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([trackId, sequenceOrder])
}

model ProjectTemplate {
  id              String      @id @default(cuid())
  trackId         String
  name            String
  description     String
  difficulty      Int
  estimatedHours  Float?
  skills          String[]    // Skills this project teaches

  // Project content
  briefMarkdown   String?     // Project brief
  starterCode     String?
  starterCodeUrl  String?     // GitHub repo
  solutionNotes   String?

  // Portfolio
  isPortfolioWorthy Boolean   @default(true)

  track           CareerTrack @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([trackId])
}

// ============================================
// ANALYTICS & METRICS
// ============================================

model DailyMetrics {
  id              String   @id @default(cuid())
  date            DateTime @db.Date

  // Global metrics
  totalSessions   Int      @default(0)
  totalInteractions Int    @default(0)
  activeStudents  Int      @default(0)
  newUsers        Int      @default(0)

  // Model usage
  haikuTokens     Int      @default(0)
  sonnetTokens    Int      @default(0)
  opusTokens      Int      @default(0)

  // Cost tracking
  totalCostUsd    Float    @default(0)

  // Feature usage
  crisisModeActivations Int @default(0)
  examSimulations Int      @default(0)
  nudgesSent      Int      @default(0)
  nudgesAccepted  Int      @default(0)

  @@unique([date])
}

// ============================================
// REAL-TIME CONNECTIONS (for WebSocket tracking)
// ============================================

model RealtimeConnection {
  id              String   @id @default(cuid())
  userId          String
  connectionId    String   @unique
  channel         String   // student, classroom, notifications
  metadata        Json?

  connectedAt     DateTime @default(now())
  lastPingAt      DateTime @default(now())

  @@index([userId])
  @@index([channel])
}
